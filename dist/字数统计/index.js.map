{"version":3,"file":"index.js","mappings":"AACA,MAIMA,EAAiB,2CACjBC,EAAyB,+BACzBC,EAAiB,+CAEvB,SAASC,EAAgBC,GACvB,MAAMC,EAAKC,OAAOF,GACZG,EAAiBC,EAAE,eAAeH,OACxC,GAA8B,IAA1BE,EAAeE,OAAc,OAEjC,MAAMC,EAAeH,EAAeI,KAAK,wBACzC,GAA4B,IAAxBD,EAAaD,OAAc,OAE/B,MAAMG,EAAaF,EAAaG,OAAOC,MAAM,UAC7C,IAAKF,EAAY,OAGjB,MAAMG,EAAeC,gBAAgBX,GACrC,IAAKU,GAAwC,IAAxBA,EAAaN,OAAc,OAEhD,IAAIQ,EAAUF,EAAa,GAAGG,SAAW,GAIvCD,EAAUA,EAAQE,QAAQnB,EAAgB,IAE1CiB,EAAUA,EAAQE,QAAQlB,EAAwB,IAIpDgB,EAAUA,EAAQE,QAAQjB,EAAgB,IAE1C,MAAMkB,EAAeH,EAAQR,OAC7B,IAAIY,EAAiB,EAEA,CAEnB,IAAIC,EAAYP,EAAa,GAAGQ,OAAOD,WAAa,GAElDA,EAAYA,EAAUH,QAAQnB,EAAgB,IAC9CsB,EAAYA,EAAUH,QAAQlB,EAAwB,IAExDoB,EAAiBC,EAAUb,MAC7B,CAEA,MAAMe,EAAaZ,EAAW,GACxBa,EACeJ,EAAiB,EAChC,GAAGG,MAAeH,KAAkBD,KACpC,GAAGI,MAAeJ,KAExBV,EAAaG,KAAKY,EACpB,CAEAjB,EAAE,KACAkB,QAAQC,cAAcC,iBAAkBxB,IACtCyB,WAAW,IAAM1B,EAAgBG,OAAOF,IAAa,OAGvDsB,QAAQC,cAAcG,gBAAiB1B,IACrCyB,WAAW,IAAM1B,EAAgBG,OAAOF,IAAa,OAGvDsB,QAAQC,cAAcI,sBAAuB,CAACC,EAAGC,EAAI7B,KACnDyB,WAAW,IAAM1B,EAAgBC,GAAY","sources":["src://tavern_helper_template/src/字数统计/index.ts"],"sourcesContent":["// 配置开关\nconst IGNORE_TAGS = true; // 是否忽略 <标签>内容</标签> 格式\nconst COUNT_REASONING = true; // 是否统计思考内容\n\n// 预编译正则表达式以提高性能\nconst TAG_PAIR_REGEX = /<([^>/\\s]+)(?:\\s+[^>]*)?>[\\s\\S]*?<\\/\\1>/g;\nconst SELF_CLOSING_TAG_REGEX = /<([^>/\\s]+)(?:\\s+[^>]*)?\\/>/g;\nconst MAINTEXT_REGEX = /<maintext(?:\\s+[^>]*)?>[\\s\\S]*?<\\/maintext>/g;\n\nfunction updateWordCount(messageId: number | string) {\n  const id = Number(messageId);\n  const messageElement = $(`.mes[mesid=\"${id}\"]`);\n  if (messageElement.length === 0) return;\n\n  const tokenElement = messageElement.find('.tokenCounterDisplay');\n  if (tokenElement.length === 0) return;\n\n  const tokenMatch = tokenElement.text().match(/(\\d+)t/);\n  if (!tokenMatch) return;\n\n  // 获取原始消息文本，避免 HTML 渲染干扰\n  const chatMessages = getChatMessages(id);\n  if (!chatMessages || chatMessages.length === 0) return;\n\n  let content = chatMessages[0].message || '';\n\n  if (IGNORE_TAGS) {\n    // 移除 <标签>内容</标签>\n    content = content.replace(TAG_PAIR_REGEX, '');\n    // 移除自闭合标签 <标签 />\n    content = content.replace(SELF_CLOSING_TAG_REGEX, '');\n  }\n\n  // 额外确保忽略 <maintext>\n  content = content.replace(MAINTEXT_REGEX, '');\n\n  const contentCount = content.length;\n  let reasoningCount = 0;\n\n  if (COUNT_REASONING) {\n    // 思考内容通常在 extra.reasoning 中\n    let reasoning = chatMessages[0].extra?.reasoning || '';\n    if (IGNORE_TAGS) {\n      reasoning = reasoning.replace(TAG_PAIR_REGEX, '');\n      reasoning = reasoning.replace(SELF_CLOSING_TAG_REGEX, '');\n    }\n    reasoningCount = reasoning.length;\n  }\n\n  const tokenCount = tokenMatch[1];\n  const newText =\n    COUNT_REASONING && reasoningCount > 0\n      ? `${tokenCount}t(${reasoningCount}+${contentCount})`\n      : `${tokenCount}t(${contentCount})`;\n\n  tokenElement.text(newText);\n}\n\n$(() => {\n  eventOn(tavern_events.MESSAGE_RECEIVED, messageId => {\n    setTimeout(() => updateWordCount(Number(messageId)), 200);\n  });\n\n  eventOn(tavern_events.MESSAGE_UPDATED, messageId => {\n    setTimeout(() => updateWordCount(Number(messageId)), 200);\n  });\n\n  eventOn(tavern_events.STREAM_REASONING_DONE, (_, __, messageId) => {\n    setTimeout(() => updateWordCount(messageId), 200);\n  });\n});\n"],"names":["TAG_PAIR_REGEX","SELF_CLOSING_TAG_REGEX","MAINTEXT_REGEX","updateWordCount","messageId","id","Number","messageElement","$","length","tokenElement","find","tokenMatch","text","match","chatMessages","getChatMessages","content","message","replace","contentCount","reasoningCount","reasoning","extra","tokenCount","newText","eventOn","tavern_events","MESSAGE_RECEIVED","setTimeout","MESSAGE_UPDATED","STREAM_REASONING_DONE","_","__"],"ignoreList":[],"sourceRoot":""}